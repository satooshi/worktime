version: "3.7"
services:
  web:
    image: nginx:1.17.0-alpine
    ports:
      - "80:80"
    depends_on:
      - ruby
  postgresql:
    # dc exec postgresql psql -Upostgres
    # create role worktime_app WITH LOGIN CREATEDB PASSWORD 'worktime_password';
    image: postgres:11.4-alpine
    environment:
      PG_PASSWORD: password
    ports:
      - "5432:5432"
    volumes:
      - db:/var/lib/postgresql/data
  ruby: &app_base
    build:
      context: ./worktime-rails
      dockerfile: docker/Dockerfile
    environment:
      RAILS_ENV: development
      # DATABASE_URL: postgresql://postgres
      DATABASE_NAME: worktime_dev
      DATABASE_HOST: postgresql
      DATABASE_PORT: 5432
      RAILS_MAX_THREADS: 5
      DATABASE_USERNAME: worktime_app
      DATABASE_PASSWORD: worktime_password
      BUNDLE_APP_CONFIG: /usr/src/app/.bundle
      BUNDLE_PATH: /usr/src/app/vendor/bundle
    ports:
      - "3000:3000"
    volumes:
      - ./worktime-rails/app:/usr/src/app/app
      - ./worktime-rails/bin:/usr/src/app/bin
      - ./worktime-rails/config:/usr/src/app/config
      - ./worktime-rails/db:/usr/src/app/db
      - ./worktime-rails/lib:/usr/src/app/lib
      - ./worktime-rails/public:/usr/src/app/public
      - ./worktime-rails/storage:/usr/src/app/storage
      # - ./worktime-rails/tmp:/usr/src/app/tmp
      - ./worktime-rails/vendor:/usr/src/app/vendor
      - ./worktime-rails/.bundle:/usr/src/app/.bundle
      - ./worktime-rails/.rubocop.yml:/usr/src/app/.rubocop.yml
      - ./worktime-rails/config.ru:/usr/src/app/config.ru
      - ./worktime-rails/Gemfile:/usr/src/app/Gemfile
      - ./worktime-rails/Gemfile.lock:/usr/src/app/Gemfile.lock
      - ./worktime-rails/Rakefile:/usr/src/app/Rakefile
    depends_on:
      - postgresql
    command: /bin/sh -c "bundle exec rails server -p 3000 -b 0.0.0.0"
    tty: true
    stdin_open: true
  spring: # container for rake tasks
    # dc exec ruby bin/rails db:create
    <<: *app_base
    command: ["bundle", "exec", "spring", "server"]
    ports: []
    tty: false
    stdin_open: false
  rspec:
    # dc exec rspec bin/rspec
    <<: *app_base
    environment:
      RAILS_ENV: test
      # DATABASE_URL: postgresql://postgres
      DATABASE_NAME: worktime_test
      DATABASE_HOST: postgresql
      DATABASE_PORT: 5432
      RAILS_MAX_THREADS: 5
      DATABASE_USERNAME: worktime_app
      DATABASE_PASSWORD: worktime_password
      BUNDLE_APP_CONFIG: /usr/src/app/.bundle
      BUNDLE_PATH: /usr/src/app/vendor/bundle
    command: /bin/sh -c "sleep infinity"
    ports: []
volumes:
  db:
